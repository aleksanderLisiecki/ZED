---
title: "projekt_ZED"
author: "Aleksander Lisiecki"
date: "20 11 2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Użyte biblioteki

```{r, message=FALSE}
library(dplyr)
library(plotly)
library(ggplot2)
library(readxl)
library(tidyr)
library(knitr)
library(kableExtra)
```

***

> ### Gold Prices

#### Wczytywanie i czyszczenie danych:

* nadanie właściwych typów danych,
* pozostawienie do dalszych rozważań jedynie ceny w walucie USD,
* zmiana nazw kolumn dla AM and PM fixing,

```{r, cache=TRUE}
Gold.prices <- read.csv("C:/Users/alili/Desktop/studia/9 semestr/ZED/projekt/Data pack/Gold prices.csv", 
                        colClasses = c(rep("Date", 1),
                                       rep("numeric", 2),
                                       rep("NULL", 4)),
                        col.names = c('Date',
                                      'Morning.Fix.USD',
                                      'Afternoon.Fix.USD',
                                      rep("NULL", 4)),
                        header = TRUE)
```

* uzupełnijnie brakujących wartości (NA) w kolumnach z ceną otwarcia i zamknięcia, wartością z sąsiedniej kolumny (w całym zbiorze nie ma sytuacji gdzie brakują obydwie)

```{r}
Gold.prices <- Gold.prices %>% 
  mutate(Morning.Fix.USD = coalesce(Morning.Fix.USD, Afternoon.Fix.USD)) %>%
  mutate(Afternoon.Fix.USD = coalesce(Afternoon.Fix.USD, Morning.Fix.USD)) 
```

#### Podsumowanie danych:

Zbiór zawiera codzienne wyceny złota podczas sesji otwarcia i zamknięcia od dnia 1968-01-02 do 2021-09-29.

```{r}
head(Gold.prices)
nrow(Gold.prices)
summary(Gold.prices)
```

#### Analiza wartości ceny złota

Na wykresie widzimy zmianę cen otwarcia w czasie.

```{r}
ggplot(Gold.prices, aes(x = Date)) +
  geom_point(aes(y = Morning.Fix.USD), color = "yellow")
```

***

> ### World development indicators

#### Wczytywanie zbioru danych

```{r}
World_Development_Indicators <- read_excel("C:/Users/alili/Desktop/studia/9 semestr/ZED/projekt/Data pack/World_Development_Indicators.xlsx", 
                                           na = '..', 
                                           range = "A1:BC44305")
```

#### Czyszczenie zbioru:

* usunięcie elementów innych niż kraje z kolumny `Country Name`, pozostawienie całego swiata w zbiorze krajów, 

```{r}
World_Development_Indicators <- World_Development_Indicators %>%
  filter(!`Country Name` %in% c("Low & middle income","Low income","Lower middle income","Middle income","Upper middle income","High income"))
```


* wyodrębnienie kodów serii do osobnej tabeli oraz usunięcie jej z przetwarzanego zbioru,
* przeniesienie zmiennych do osobnych kolumn,

```{r}
World_Development_Indicators.Series_Codes <- select(World_Development_Indicators, `Series Name`, `Series Code`)
World_Development_Indicators <- select(World_Development_Indicators, -`Series Code`)
```

* przeniesienie pojedyńczych obserwacji do osobnych wierszy

```{r}
World_Development_Indicators <- World_Development_Indicators %>%
  pivot_longer(cols = `1970 [YR1970]`:`2020 [YR2020]`, names_to = "Year") %>%
  group_by(`Series Name`) %>%
  mutate(row = row_number()) %>%
  tidyr::pivot_wider(names_from = `Series Name`, values_from = value) %>%
  select(-row)
```

* poprawa kolumny Year: wyodrębnienie lat jako numerycznych wartości

```{r}
World_Development_Indicators <- World_Development_Indicators %>%
  mutate(Year = as.numeric(substr(Year, 1, 4)))
```

* pozostawiam 100 atrybutów, które mają najwięcej danych (najmniej wartości pustych) - nie jest to idealny sposób, ponieważ część państw może nie podawać w ogóle danych na różne wskaźniki, 

```{}
World_Development_Indicators %>%
  select(-(1:3)) %>%
  summarise_all(funs(sum(is.na(.)))) %>%
  t %>%
  data.frame() %>%
  top_n(-100)
  
```



#### Podsumowanie danych:

Zbiór zawiera pierdyliard wskaźników.

:::: {style="display: grid; grid-template-columns: 1fr 1fr; grid-column-gap: 10px; "}

::: {}

```{r, echo=FALSE}
World_Development_Indicators$`Country Name` %>%
  unique %>%
  data.frame() %>%
  rename('Lista krajów dostępnych w zbiorze' = '.') %>%
  kable() %>%
  kable_styling("striped", full_width = F) %>%
  scroll_box( height = '400px')
```

:::

::: {}

```{r, echo=FALSE}
World_Development_Indicators %>%
  names %>%
  data.frame() %>%
  rename('Lista dostępnych wskaźników' = '.') %>%
  kable %>%
  kable_styling("striped", full_width = F) %>%
  scroll_box(width = '650px', height = '400px')
```

:::

::::



***

> ### S&P Composite

#### Wczytywanie danych

```{r}
SP.Composite <- read.csv("C:/Users/alili/Desktop/studia/9 semestr/ZED/projekt/Data pack/S&P Composite.csv")
```

#### Czyszczenie danych:

* zmiana nazwy oraz typ na właściwy kolumny z datą
* zmiana nazwy Cyclicaly.Adjusted.PE.Ratio na skrót CAPE -

```{r}
SP.Composite <- SP.Composite %>%
  rename(Date = Year,
         CAPE = Cyclically.Adjusted.PE.Ratio) %>%
  mutate(Date = as.Date(Date))
```

#### Znaczenie atrybutów:

* S.P.Composite - nominalna wartość indexu,
* Divident - nominalna dywidenta,
* Earnings - nominalne zarobki na indeksie,
* CPI - wskaźnik cen towarów i usług konsumpcyjnych. Najpopularniejsza na świecie miara inflacji/deflacji,
* Long.Interest.Rate - stopy procentowe dziesięcioletnich obligacji rządowych,
* Real.Price - realna wartość indexu,
* Real.Divident - realna dywidenta,
* Real.Earnings - realne zarobki na indeksie,
* CAPE (Cyclicaly.Adjusted.PE.Ratio) - cyklicznie dostosowywany wskaźnik ceny do zysków. Definiuje się go jako cenę podzieloną przez średnią z dziesięciu lat zarobków, skorygowaną o inflację.

```{r}
SP.Composite %>%
  ggplot(aes(x=Date)) +
  geom_point(aes(y = S.P.Composite), color = "blue") +
  geom_point(aes(y = Real.Price), color = "red") +
  geom_point(aes(y = CPI), color = "yellow") +
  ylim(0, 1000)
```

#### Podsumowanie danych

```{r}
head(SP.Composite)
ncol(SP.Composite)
nrow(SP.Composite)
summary(SP.Composite)
```

***

> ### Currency Exchange Rates

#### Wczytywanie danych:

```{r, cache=TRUE}
Currency.Exchange.Rates <- read.csv("C:/Users/alili/Desktop/studia/9 semestr/ZED/projekt/Data pack/CurrencyExchangeRates.csv")
```

#### Czyszczenie danych:

* zmiana typu kolumny z datą

```{r}
Currency.Exchange.Rates <- Currency.Exchange.Rates %>% 
  mutate(Date = as.Date(Date))
```

#### Podsumowanie danych:

Zbiór zawiera codzienny kurs wymiany walut od dnia 1995-01-02 do 2018-05-02.

```{r}
Currency.Exchange.Rates %>%
  names %>%
  data.frame() %>%
  rename('Dostępne waluty' = '.') %>%
  kable %>%
  kable_styling("striped", full_width = F) %>%
  scroll_box(width = '400px', height = '400px')

```

***
***

> #### Analizy:

***

#### Animowany wykres zmiany liczby ludności w czasie (Wcisnąć play z puszczoną w tle piosenką Queen "Another One Bites the Dust"):

```{r, echo=FALSE, message=FALSE, warning=FALSE, fig.width=9,fig.height=6}
specify_decimal <- function(x, k) trimws(format(round(x, k), nsmall=k))

World.Population.Top10 <- World_Development_Indicators %>%
  filter(`Country Name` != "World") %>%
  rename(Population = `Population, total`) %>%
  select(`Country Name`, Year, Population) %>%
  group_by(Year) %>%
  arrange(desc(Population), .by_group = T) %>%
  top_n(11) %>%
  mutate(`Population in mln` = Population/10^6, Rank = rank(Population))

p <- World.Population.Top10 %>%
  ggplot(aes(Rank, Population, fill = `Country Name`)) +
  geom_col(aes(frame = Year), position = "identity") +
  geom_text(aes(frame = Year, y = Population + 1.5*10^8, label = paste0(round(`Population in mln`,2), 'mln')), hjust = 0) +
  geom_text(aes(frame = Year, y = `Population in mln`/2, label = `Country Name`), hjust = 0) +
  ylim(-10^8,1.6*10^9) +
  coord_flip() +
  theme_minimal() +
  ggtitle("Populacja świata w latach 1970-2020") +
  theme(axis.line=element_blank(),
        axis.text.x=element_blank(),
        axis.text.y=element_blank(),
        axis.ticks=element_blank(),
        axis.title.x=element_blank(),
        axis.title.y=element_blank(),
        legend.position="none",
        plot.title=element_text(size=22, hjust=0.5, face="bold", colour="grey")) 

ggplotly(p)
```

```{r}
World.Population.Top10 
```

***

#### Samobójstwa kobiet i mężczyzn na świecie w latach 2000-2019:

```{r, echo=FALSE, message=FALSE, warning=FALSE}

suicides <- World_Development_Indicators %>%
  filter(`Country Name` == 'World') %>%
  select(Year, `Suicide mortality rate, female (per 100,000 female population)`, `Suicide mortality rate, male (per 100,000 male population)`) %>%
  filter(!is.na(`Suicide mortality rate, female (per 100,000 female population)`))

suicides.male <- suicides %>%
  select(Year, `Suicide mortality rate, male (per 100,000 male population)`) %>%
  rename(`Suicide mortality rate (per 100,000 of given gender population)` = `Suicide mortality rate, male (per 100,000 male population)`) %>%
  mutate(gender = 'male')

suicides.female <- suicides %>%
  select(Year, `Suicide mortality rate, female (per 100,000 female population)`) %>%
  rename(`Suicide mortality rate (per 100,000 of given gender population)` = `Suicide mortality rate, female (per 100,000 female population)`) %>%
  mutate(gender = 'female')

suicides.per.gender <- rbind.data.frame(suicides.male, suicides.female)

suicides.per.gender %>%
  ggplot(aes(x = Year, y = `Suicide mortality rate (per 100,000 of given gender population)`)) +
  geom_line(aes(colour = gender), size = 1) +
  geom_point(colour = 'royalblue', size = 2) +
  expand_limits(y = 0) +
  ggtitle('Współczynnik samobójstw (na 100,000 osób danej płci)') +
  ylab('') +
  theme_bw() -> p
  ggplotly(p)

```

Wniosek: 
Liczba samobójstw jest w trendzie spadkowym, zdrowie psychiczne ludzkości się polepsza.  

***

#### Korelacja atrybutów zbioru World Development Indicators do ceny złota:

```{}
df.gold <- Gold.prices %>%
  arrange(desc(row_number()))

df.WDI <- World_Development_Indicators %>%
  filter(`Country Name` == "USA")

```

